#include "rodos.h"
#include "config_mpc.h"
#include "topic_config.h"
#include "controller_mpc.h"
#include"magnet.h"

class current_ctrl : public Thread
{

    RODOS::VECTOR_F<600> Approach_Lookup{(float[]){5029600,4074000,314350,254630,
        62096,50298,
        19649,15915,
        8049.1,6519.8,
        3882.6,3144.9,
        2096.5,1698.2,
        1229.6,995.97,
        768.22,622.26,
        504.55,408.69,
        345.08,279.52,
        244.07,197.7,
        177.57,143.83,
        132.36,107.21,
        100.74,81.597,
        78.089,63.252,
        61.518,49.83,
        49.166,39.824,
        39.803,32.24,
        32.599,26.405,
        26.981,21.855,
        22.546,18.262,
        19.005,15.394,
        16.149,13.081,
        13.824,11.197,
        11.914,9.6504,
        10.332,8.3693,
        9.013,7.3005,
        7.9043,6.4025,
        6.9668,5.6431,
        6.1691,4.9969,
        5.4864,4.444,
        4.899,3.9682,
        4.391,3.5567,
        3.9496,3.1992,
        3.5644,2.8871,
        3.2267,2.6136,
        2.9295,2.3729,
        2.667,2.1602,
        2.4342,1.9717,
        2.2272,1.804,
        2.0425,1.6544,
        1.8771,1.5204,
        1.7287,1.4002,
        1.595,1.292,
        1.4745,1.1943,
        1.3654,1.106,
        1.2665,1.0258,
        1.1766,0.95303,
        1.0947,0.88672,
        1.02,0.82621,
        0.95171,0.77088,
        0.88915,0.72021,
        0.83174,0.67371,
        0.77897,0.63097,
        0.7304,0.59162,
        0.68561,0.55535,
        0.64426,0.52185,
        0.60602,0.49088,
        0.57061,0.4622,
        0.53779,0.43561,
        0.50732,0.41093,
        0.479,0.38799,
        0.45264,0.36664,
        0.4281,0.34676,
        0.40521,0.32822,
        0.38384,0.31091,
        0.36387,0.29474,
        0.3452,0.27961,
        0.32771,0.26545,
        0.31133,0.25218,
        0.29596,0.23973,
        0.28154,0.22804,
        0.26799,0.21707,
        0.25524,0.20675,
        0.24325,0.19704,
        0.23197,0.18789,
        0.22133,0.17927,
        0.21129,0.17115,
        0.20182,0.16348,
        0.19288,0.15624,
        0.18443,0.14939,
        0.17644,0.14292,
        0.16889,0.1368,
        0.16173,0.131,
        0.15495,0.12551,
        0.14852,0.1203,
        0.14243,0.11537,
        0.13664,0.11068,
        0.13115,0.10623,
        0.12593,0.10201,
        0.12097,0.09799,
        0.11626,0.09417,
        0.11177,0.090536,
        0.1075,0.087076,
        0.10343,0.083782,
        0.099558,0.080642,
        0.095864,0.07765,
        0.09234,0.074796,
        0.088979,0.072073,
        0.08577,0.069474,
        0.082705,0.066991,
        0.079778,0.06462,
        0.07698,0.062354,
        0.074305,0.060187,
        0.071746,0.058114,
        0.069297,0.056131,
        0.066953,0.054232,
        0.064709,0.052414,
        0.062558,0.050672,
        0.060498,0.049003,
        0.058522,0.047403,
        0.056628,0.045869,
        0.05481,0.044396,
        0.053066,0.042984,
        0.051392,0.041627,
        0.049784,0.040325,
        0.048239,0.039074,
        0.046755,0.037871,
        0.045328,0.036716,
        0.043956,0.035604,
        0.042636,0.034535,
        0.041367,0.033507,
        0.040145,0.032517,
        0.038968,0.031564,
        0.037836,0.030647,
        0.036744,0.029763,
        0.035693,0.028911,
        0.034679,0.02809,
        0.033703,0.027299,
        0.03276,0.026536,
        0.031852,0.0258,
        0.030975,0.02509,
        0.030129,0.024404,
        0.029312,0.023742,
        0.028523,0.023103,
        0.027761,0.022486,
        0.027025,0.02189,
        0.026314,0.021314,
        0.025626,0.020757,
        0.024962,0.020219,
        0.024319,0.019698,
        0.023698,0.019195,
        0.023096,0.018708,
        0.022514,0.018237,
        0.021951,0.01778,
        0.021406,0.017339,
        0.020878,0.016911,
        0.020366,0.016497,
        0.019871,0.016095,
        0.019391,0.015707,
        0.018926,0.01533,
        0.018475,0.014965,
        0.018038,0.014611,
        0.017614,0.014267,
        0.017203,0.013934,
        0.016804,0.013611,
        0.016417,0.013297,
        0.016041,0.012993,
        0.015676,0.012698,
        0.015322,0.012411,
        0.014979,0.012133,
        0.014645,0.011862,
        0.01432,0.011599,
        0.014005,0.011344,
        0.013699,0.011096,
        0.013401,0.010855,
        0.013112,0.010621,
        0.012831,0.010393,
        0.012557,0.010171,
        0.012291,0.009956,
        0.012033,0.0097464,
        0.011781,0.0095425,
        0.011536,0.009344,
        0.011297,0.0091509,
        0.011065,0.0089629,
        0.010839,0.0087799,
        0.010619,0.0086017,
        0.010405,0.0084282,
        0.010196,0.0082591,
        0.0099932,0.0080945,
        0.0097951,0.007934,
        0.0096021,0.0077777,
        0.009414,0.0076253,
        0.0092307,0.0074768,
        0.0090519,0.0073321,
        0.0088777,0.0071909,
        0.0087077,0.0070532,
        0.008542,0.006919,
        0.0083803,0.006788,
        0.0082226,0.0066603,
        0.0080687,0.0065356,
        0.0079185,0.006414,
        0.0077719,0.0062953,
        0.0076289,0.0061794,
        0.0074892,0.0060663,
        0.0073529,0.0059558,
        0.0072197,0.005848,
        0.0070897,0.0057426,
        0.0069627,0.0056398,
        0.0068386,0.0055393,
        0.0067174,0.0054411,
        0.006599,0.0053452,
        0.0064832,0.0052514,
        0.0063701,0.0051598,
        0.0062596,0.0050702,
        0.0061515,0.0049827,
        0.0060458,0.0048971,
        0.0059425,0.0048134,
        0.0058414,0.0047316,
        0.0057426,0.0046515,
        0.005646,0.0045732,
        0.0055514,0.0044966,
        0.0054589,0.0044217,
        0.0053684,0.0043484,
        0.0052798,0.0042766,
        0.0051931,0.0042064,
        0.0051083,0.0041377,
        0.0050252,0.0040704,
        0.0049439,0.0040046,
        0.0048643,0.0039401,
        0.0047863,0.0038769,
        0.00471,0.0038151,
        0.0046352,0.0037545,
        0.004562,0.0036952,
        0.0044903,0.0036371,
        0.00442,0.0035802,
        0.0043511,0.0035244,
        0.0042836,0.0034698,
        0.0042175,0.0034162,
        0.0041527,0.0033637,
        0.0040892,0.0033122,
        0.0040269,0.0032618,
        0.0039659,0.0032124,
        0.003906,0.0031639,
        0.0038474,0.0031164,
        0.0037898,0.0030698,
        0.0037334,0.003024,
        0.003678,0.0029792,
        0.0036237,0.0029352,
        0.0035705,0.0028921,
        0.0035182,0.0028498,
        0.003467,0.0028082,
        0.0034167,0.0027675,
        0.0033673,0.0027275,
        0.0033189,0.0026883,
        0.0032713,0.0026498,
        0.0032247,0.002612,
        0.0031789,0.0025749,
        0.0031339,0.0025385,
        0.0030897,0.0025027,
        0.0030464,0.0024676,
        0.0030038,0.0024331,
        0.002962,0.0023992,
        0.002921,0.002366,
        0.0028807,0.0023333,
        0.0028411,0.0023013,
        0.0028021,0.0022697,
        0.0027639,0.0022388,
        0.0027264,0.0022084,
        0.0026895,0.0021785,
        0.0026532,0.0021491,
        0.0026176,0.0021203,
        0.0025826,0.0020919,
        0.0025482,0.002064,
        0.0025144,0.0020366,
        0.0024811,0.0020097,
        0.0024485,0.0019833,
        0.0024163,0.0019572,
        0.0023847,0.0019316,
        0.0023537,0.0019065,
        0.0023232,0.0018818,
        0.0022931,0.0018574,
        0.0022636,0.0018335,
        0.0022346,0.00181,
        0.002206,0.0017868,
        0.0021779,0.0017641,
        0.0021502,0.0017417,
        0.0021231,0.0017197,
        0.0020963,0.001698,
        0.00207,0.0016767,
        0.0020441,0.0016557,
        0.0020186,0.0016351,
        0.0019935,0.0016148,
        0.0019689,0.0015948,
        0.0019446,0.0015751,
        0.0019207,0.0015557,
        0.0018971,0.0015367,
        0.001874,0.0015179,
        0.0018512,0.0014995,
        0.0018287,0.0014813,
        0.0018066,0.0014634,
        0.0017849,0.0014458,
        0.0017635,0.0014284,
        0.0017424,0.0014113,
        0.0017216,0.0013945,
        0.0017012,0.0013779,
        0.001681,0.0013616,
        0.0016612,0.0013455,
        0.0016416,0.0013297,
        },("Approach phase force to i relation")};
    RODOS::VECTOR_F<600> Allign_Lookup{{},("Allign phase force to i relation")};

    struct data_desired_current current1;
    allignment_phase L1 = ALLIGNMENT;
    float arr_offset = 0;
    float dist;
    float mpc_current_req;

public:

    current_ctrl(const char* thread_name, const int priority , const int stack_size) : Thread(thread_name , priority , stack_size){}

    data_desired_current convert_f_to_i(float d , float f , allignment_phase L1);
    void publish_current_data();
    void init();
    void run();

}