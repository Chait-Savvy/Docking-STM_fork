#ifndef _CONTROLLER_CURRENT_H_
#define _CONTROLLER_CURRENT_H_

#include "rodos.h"
#include "config_mpc.h"
#include "topic_config.h"
#include "magnet.h"
#include "pid.h"

#include<math.h>

class current_ctrl : public Thread
{

    // RODOS::Matrix_F<300,2> Approach_Lookup{(float[]){5029600,4074000,314350,254630,
    //     62096,50298,
    //     19649,15915,
    //     8049.1,6519.8,
    //     3882.6,3144.9,
    //     2096.5,1698.2,
    //     1229.6,995.97,
    //     768.22,622.26,
    //     504.55,408.69,
    //     345.08,279.52,
    //     244.07,197.7,
    //     177.57,143.83,
    //     132.36,107.21,
    //     100.74,81.597,
    //     78.089,63.252,
    //     61.518,49.83,
    //     49.166,39.824,
    //     39.803,32.24,
    //     32.599,26.405,
    //     26.981,21.855,
    //     22.546,18.262,
    //     19.005,15.394,
    //     16.149,13.081,
    //     13.824,11.197,
    //     11.914,9.6504,
    //     10.332,8.3693,
    //     9.013,7.3005,
    //     7.9043,6.4025,
    //     6.9668,5.6431,
    //     6.1691,4.9969,
    //     5.4864,4.444,
    //     4.899,3.9682,
    //     4.391,3.5567,
    //     3.9496,3.1992,
    //     3.5644,2.8871,
    //     3.2267,2.6136,
    //     2.9295,2.3729,
    //     2.667,2.1602,
    //     2.4342,1.9717,
    //     2.2272,1.804,
    //     2.0425,1.6544,
    //     1.8771,1.5204,
    //     1.7287,1.4002,
    //     1.595,1.292,
    //     1.4745,1.1943,
    //     1.3654,1.106,
    //     1.2665,1.0258,
    //     1.1766,0.95303,
    //     1.0947,0.88672,
    //     1.02,0.82621,
    //     0.95171,0.77088,
    //     0.88915,0.72021,
    //     0.83174,0.67371,
    //     0.77897,0.63097,
    //     0.7304,0.59162,
    //     0.68561,0.55535,
    //     0.64426,0.52185,
    //     0.60602,0.49088,
    //     0.57061,0.4622,
    //     0.53779,0.43561,
    //     0.50732,0.41093,
    //     0.479,0.38799,
    //     0.45264,0.36664,
    //     0.4281,0.34676,
    //     0.40521,0.32822,
    //     0.38384,0.31091,
    //     0.36387,0.29474,
    //     0.3452,0.27961,
    //     0.32771,0.26545,
    //     0.31133,0.25218,
    //     0.29596,0.23973,
    //     0.28154,0.22804,
    //     0.26799,0.21707,
    //     0.25524,0.20675,
    //     0.24325,0.19704,
    //     0.23197,0.18789,
    //     0.22133,0.17927,
    //     0.21129,0.17115,
    //     0.20182,0.16348,
    //     0.19288,0.15624,
    //     0.18443,0.14939,
    //     0.17644,0.14292,
    //     0.16889,0.1368,
    //     0.16173,0.131,
    //     0.15495,0.12551,
    //     0.14852,0.1203,
    //     0.14243,0.11537,
    //     0.13664,0.11068,
    //     0.13115,0.10623,
    //     0.12593,0.10201,
    //     0.12097,0.09799,
    //     0.11626,0.09417,
    //     0.11177,0.090536,
    //     0.1075,0.087076,
    //     0.10343,0.083782,
    //     0.099558,0.080642,
    //     0.095864,0.07765,
    //     0.09234,0.074796,
    //     0.088979,0.072073,
    //     0.08577,0.069474,
    //     0.082705,0.066991,
    //     0.079778,0.06462,
    //     0.07698,0.062354,
    //     0.074305,0.060187,
    //     0.071746,0.058114,
    //     0.069297,0.056131,
    //     0.066953,0.054232,
    //     0.064709,0.052414,
    //     0.062558,0.050672,
    //     0.060498,0.049003,
    //     0.058522,0.047403,
    //     0.056628,0.045869,
    //     0.05481,0.044396,
    //     0.053066,0.042984,
    //     0.051392,0.041627,
    //     0.049784,0.040325,
    //     0.048239,0.039074,
    //     0.046755,0.037871,
    //     0.045328,0.036716,
    //     0.043956,0.035604,
    //     0.042636,0.034535,
    //     0.041367,0.033507,
    //     0.040145,0.032517,
    //     0.038968,0.031564,
    //     0.037836,0.030647,
    //     0.036744,0.029763,
    //     0.035693,0.028911,
    //     0.034679,0.02809,
    //     0.033703,0.027299,
    //     0.03276,0.026536,
    //     0.031852,0.0258,
    //     0.030975,0.02509,
    //     0.030129,0.024404,
    //     0.029312,0.023742,
    //     0.028523,0.023103,
    //     0.027761,0.022486,
    //     0.027025,0.02189,
    //     0.026314,0.021314,
    //     0.025626,0.020757,
    //     0.024962,0.020219,
    //     0.024319,0.019698,
    //     0.023698,0.019195,
    //     0.023096,0.018708,
    //     0.022514,0.018237,
    //     0.021951,0.01778,
    //     0.021406,0.017339,
    //     0.020878,0.016911,
    //     0.020366,0.016497,
    //     0.019871,0.016095,
    //     0.019391,0.015707,
    //     0.018926,0.01533,
    //     0.018475,0.014965,
    //     0.018038,0.014611,
    //     0.017614,0.014267,
    //     0.017203,0.013934,
    //     0.016804,0.013611,
    //     0.016417,0.013297,
    //     0.016041,0.012993,
    //     0.015676,0.012698,
    //     0.015322,0.012411,
    //     0.014979,0.012133,
    //     0.014645,0.011862,
    //     0.01432,0.011599,
    //     0.014005,0.011344,
    //     0.013699,0.011096,
    //     0.013401,0.010855,
    //     0.013112,0.010621,
    //     0.012831,0.010393,
    //     0.012557,0.010171,
    //     0.012291,0.009956,
    //     0.012033,0.0097464,
    //     0.011781,0.0095425,
    //     0.011536,0.009344,
    //     0.011297,0.0091509,
    //     0.011065,0.0089629,
    //     0.010839,0.0087799,
    //     0.010619,0.0086017,
    //     0.010405,0.0084282,
    //     0.010196,0.0082591,
    //     0.0099932,0.0080945,
    //     0.0097951,0.007934,
    //     0.0096021,0.0077777,
    //     0.009414,0.0076253,
    //     0.0092307,0.0074768,
    //     0.0090519,0.0073321,
    //     0.0088777,0.0071909,
    //     0.0087077,0.0070532,
    //     0.008542,0.006919,
    //     0.0083803,0.006788,
    //     0.0082226,0.0066603,
    //     0.0080687,0.0065356,
    //     0.0079185,0.006414,
    //     0.0077719,0.0062953,
    //     0.0076289,0.0061794,
    //     0.0074892,0.0060663,
    //     0.0073529,0.0059558,
    //     0.0072197,0.005848,
    //     0.0070897,0.0057426,
    //     0.0069627,0.0056398,
    //     0.0068386,0.0055393,
    //     0.0067174,0.0054411,
    //     0.006599,0.0053452,
    //     0.0064832,0.0052514,
    //     0.0063701,0.0051598,
    //     0.0062596,0.0050702,
    //     0.0061515,0.0049827,
    //     0.0060458,0.0048971,
    //     0.0059425,0.0048134,
    //     0.0058414,0.0047316,
    //     0.0057426,0.0046515,
    //     0.005646,0.0045732,
    //     0.0055514,0.0044966,
    //     0.0054589,0.0044217,
    //     0.0053684,0.0043484,
    //     0.0052798,0.0042766,
    //     0.0051931,0.0042064,
    //     0.0051083,0.0041377,
    //     0.0050252,0.0040704,
    //     0.0049439,0.0040046,
    //     0.0048643,0.0039401,
    //     0.0047863,0.0038769,
    //     0.00471,0.0038151,
    //     0.0046352,0.0037545,
    //     0.004562,0.0036952,
    //     0.0044903,0.0036371,
    //     0.00442,0.0035802,
    //     0.0043511,0.0035244,
    //     0.0042836,0.0034698,
    //     0.0042175,0.0034162,
    //     0.0041527,0.0033637,
    //     0.0040892,0.0033122,
    //     0.0040269,0.0032618,
    //     0.0039659,0.0032124,
    //     0.003906,0.0031639,
    //     0.0038474,0.0031164,
    //     0.0037898,0.0030698,
    //     0.0037334,0.003024,
    //     0.003678,0.0029792,
    //     0.0036237,0.0029352,
    //     0.0035705,0.0028921,
    //     0.0035182,0.0028498,
    //     0.003467,0.0028082,
    //     0.0034167,0.0027675,
    //     0.0033673,0.0027275,
    //     0.0033189,0.0026883,
    //     0.0032713,0.0026498,
    //     0.0032247,0.002612,
    //     0.0031789,0.0025749,
    //     0.0031339,0.0025385,
    //     0.0030897,0.0025027,
    //     0.0030464,0.0024676,
    //     0.0030038,0.0024331,
    //     0.002962,0.0023992,
    //     0.002921,0.002366,
    //     0.0028807,0.0023333,
    //     0.0028411,0.0023013,
    //     0.0028021,0.0022697,
    //     0.0027639,0.0022388,
    //     0.0027264,0.0022084,
    //     0.0026895,0.0021785,
    //     0.0026532,0.0021491,
    //     0.0026176,0.0021203,
    //     0.0025826,0.0020919,
    //     0.0025482,0.002064,
    //     0.0025144,0.0020366,
    //     0.0024811,0.0020097,
    //     0.0024485,0.0019833,
    //     0.0024163,0.0019572,
    //     0.0023847,0.0019316,
    //     0.0023537,0.0019065,
    //     0.0023232,0.0018818,
    //     0.0022931,0.0018574,
    //     0.0022636,0.0018335,
    //     0.0022346,0.00181,
    //     0.002206,0.0017868,
    //     0.0021779,0.0017641,
    //     0.0021502,0.0017417,
    //     0.0021231,0.0017197,
    //     0.0020963,0.001698,
    //     0.00207,0.0016767,
    //     0.0020441,0.0016557,
    //     0.0020186,0.0016351,
    //     0.0019935,0.0016148,
    //     0.0019689,0.0015948,
    //     0.0019446,0.0015751,
    //     0.0019207,0.0015557,
    //     0.0018971,0.0015367,
    //     0.001874,0.0015179,
    //     0.0018512,0.0014995,
    //     0.0018287,0.0014813,
    //     0.0018066,0.0014634,
    //     0.0017849,0.0014458,
    //     0.0017635,0.0014284,
    //     0.0017424,0.0014113,
    //     0.0017216,0.0013945,
    //     0.0017012,0.0013779,
    //     0.001681,0.0013616,
    //     0.0016612,0.0013455,
    //     0.0016416,0.0013297
    //     },("Approach phase force to i relation")};
    // RODOS::Matrix_F<300,2> Allign_Lookup{(float[]){2514800,2037000,
    //     157180,127310,
    //     31047,25148,
    //     9823.5,7957,
    //     4023.7,3259.2,
    //     1940.4,1571.8,
    //     1047.4,848.4,
    //     613.97,497.31,
    //     383.3,310.47,
    //     251.48,203.7,
    //     171.77,139.13,
    //     121.28,98.235,
    //     88.051,71.322,
    //     65.463,53.025,
    //     49.676,40.238,
    //     38.374,31.083,
    //     30.111,24.39,
    //     23.957,19.405,
    //     19.298,15.631,
    //     15.718,12.732,
    //     12.932,10.475,
    //     10.736,8.6961,
    //     8.9872,7.2796,
    //     7.5805,6.1402,
    //     6.4385,5.2152,
    //     5.5038,4.4581,
    //     4.7327,3.8335,
    //     4.092,3.3145,
    //     3.5562,2.8805,
    //     3.1053,2.5153,
    //     2.7237,2.2062,
    //     2.3989,1.9431,
    //     2.1212,1.7181,
    //     1.8825,1.5248,
    //     1.6764,1.3579,
    //     1.4979,1.2133,
    //     1.3424,1.0874,
    //     1.2067,0.9774,
    //     1.0876,0.88099,
    //     0.98294,0.79618,
    //     0.89055,0.72135,
    //     0.80877,0.6551,
    //     0.73617,0.5963,
    //     0.67155,0.54395,
    //     0.61386,0.49723,
    //     0.56225,0.45542,
    //     0.51595,0.41792,
    //     0.47432,0.3842,
    //     0.43682,0.35382,
    //     0.40295,0.32639,
    //     0.3723,0.30157,
    //     0.34452,0.27906,
    //     0.31929,0.25862,
    //     0.29632,0.24002,
    //     0.27539,0.22307,
    //     0.25628,0.20759,
    //     0.2388,0.19343,
    //     0.22279,0.18046,
    //     0.2081,0.16856,
    //     0.1946,0.15763,
    //     0.18219,0.14757,
    //     0.17075,0.1383,
    //     0.16019,0.12976,
    //     0.15044,0.12186,
    //     0.14143,0.11456,
    //     0.13308,0.1078,
    //     0.12534,0.10153,
    //     0.11816,0.095709,
    //     0.11149,0.090303,
    //     0.10528,0.085275,
    //     0.099498,0.080594,
    //     0.094111,0.07623,
    //     0.089086,0.07216,
    //     0.084393,0.068358,
    //     0.080007,0.064806,
    //     0.075903,0.061482,
    //     0.072061,0.058369,
    //     0.06846,0.055452,
    //     0.065082,0.052716,
    //     0.061911,0.050148,
    //     0.058933,0.047736,
    //     0.056132,0.045467,
    //     0.053497,0.043333,
    //     0.051016,0.041323,
    //     0.048679,0.03943,
    //     0.046474,0.037644,
    //     0.044394,0.035959,
    //     0.04243,0.034369,
    //     0.040575,0.032865,
    //     0.03882,0.031444,
    //     0.037161,0.0301,
    //     0.035589,0.028827,
    //     0.034101,0.027622,
    //     0.032691,0.02648,
    //     0.031353,0.025396,
    //     0.030084,0.024368,
    //     0.02888,0.023392,
    //     0.027735,0.022466,
    //     0.026648,0.021585,
    //     0.025614,0.020747,
    //     0.02463,0.01995,
    //     0.023693,0.019192,
    //     0.022802,0.018469,
    //     0.021952,0.017781,
    //     0.021142,0.017125,
    //     0.02037,0.0165,
    //     0.019633,0.015903,
    //     0.01893,0.015333,
    //     0.018258,0.014789,
    //     0.017616,0.014269,
    //     0.017003,0.013773,
    //     0.016417,0.013298,
    //     0.015856,0.012843,
    //     0.015319,0.012409,
    //     0.014806,0.011993,
    //     0.014314,0.011594,
    //     0.013842,0.011212,
    //     0.013391,0.010846,
    //     0.012958,0.010496,
    //     0.012542,0.010159,
    //     0.012144,0.0098363,
    //     0.011761,0.0095265,
    //     0.011394,0.009229,
    //     0.011041,0.0089434,
    //     0.010702,0.0086689,
    //     0.010377,0.0084051,
    //     0.010064,0.0081515,
    //     0.0097625,0.0079076,
    //     0.0094728,0.007673,
    //     0.0091941,0.0074472,
    //     0.0089258,0.0072299,
    //     0.0086674,0.0070206,
    //     0.0084186,0.006819,
    //     0.0081788,0.0066249,
    //     0.0079478,0.0064377,
    //     0.0077251,0.0062573,
    //     0.0075103,0.0060833,
    //     0.0073031,0.0059156,
    //     0.0071033,0.0057537,
    //     0.0069104,0.0055974,
    //     0.0067242,0.0054466,
    //     0.0065444,0.005301,
    //     0.0063708,0.0051603,
    //     0.006203,0.0050245,
    //     0.0060409,0.0048932,
    //     0.0058843,0.0047662,
    //     0.0057328,0.0046436,
    //     0.0055863,0.0045249,
    //     0.0054446,0.0044101,
    //     0.0053075,0.0042991,
    //     0.0051749,0.0041916,
    //     0.0050465,0.0040876,
    //     0.0049222,0.0039869,
    //     0.0048018,0.0038894,
    //     0.0046852,0.003795,
    //     0.0045722,0.0037035,
    //     0.0044627,0.0036148,
    //     0.0043566,0.0035289,
    //     0.0042538,0.0034456,
    //     0.004154,0.0033648,
    //     0.0040573,0.0032864,
    //     0.0039635,0.0032104,
    //     0.0038725,0.0031367,
    //     0.0037841,0.0030652,
    //     0.0036984,0.0029957,
    //     0.0036152,0.0029283,
    //     0.0035343,0.0028628,
    //     0.0034558,0.0027992,
    //     0.0033796,0.0027375,
    //     0.0033055,0.0026775,
    //     0.0032335,0.0026192,
    //     0.0031636,0.0025625,
    //     0.0030956,0.0025074,
    //     0.0030295,0.0024539,
    //     0.0029652,0.0024018,
    //     0.0029027,0.0023512,
    //     0.0028418,0.0023019,
    //     0.0027827,0.002254,
    //     0.0027251,0.0022073,
    //     0.002669,0.0021619,
    //     0.0026145,0.0021177,
    //     0.0025614,0.0020747,
    //     0.0025097,0.0020328,
    //     0.0024593,0.001992,
    //     0.0024102,0.0019523,
    //     0.0023625,0.0019136,
    //     0.0023159,0.0018759,
    //     0.0022705,0.0018391,
    //     0.0022263,0.0018033,
    //     0.0021832,0.0017684,
    //     0.0021412,0.0017343,
    //     0.0021002,0.0017012,
    //     0.0020602,0.0016688,
    //     0.0020213,0.0016372,
    //     0.0019832,0.0016064,
    //     0.0019461,0.0015764,
    //     0.0019099,0.0015471,
    //     0.0018746,0.0015184,
    //     0.0018402,0.0014905,
    //     0.0018065,0.0014633,
    //     0.0017736,0.0014367,
    //     0.0017416,0.0014107,
    //     0.0017102,0.0013853,
    //     0.0016796,0.0013605,
    //     0.0016498,0.0013363,
    //     0.0016206,0.0013127,
    //     0.001592,0.0012895,
    //     0.0015642,0.001267,
    //     0.0015369,0.0012449,
    //     0.0015103,0.0012233,
    //     0.0014843,0.0012022,
    //     0.0014588,0.0011816,
    //     0.0014339,0.0011615,
    //     0.0014096,0.0011418,
    //     0.0013858,0.0011225,
    //     0.0013625,0.0011036,
    //     0.0013398,0.0010852,
    //     0.0013175,0.0010672,
    //     0.0012957,0.0010495,
    //     0.0012744,0.0010322,
    //     0.0012535,0.0010153,
    //     0.0012331,0.00099877,
    //     0.0012131,0.00098258,
    //     0.0011935,0.00096672,
    //     0.0011743,0.00095119,
    //     0.0011555,0.00093599,
    //     0.0011372,0.0009211,
    //     0.0011192,0.00090652,
    //     0.0011015,0.00089224,
    //     0.0010843,0.00087825,
    //     0.0010673,0.00086454,
    //     0.0010508,0.00085111,
    //     0.0010345,0.00083795,
    //     0.0010186,0.00082505,
    //     0.001003,0.00081242,
    //     0.00098769,0.00080003,
    //     0.0009727,0.00078788,
    //     0.000958,0.00077598,
    //     0.00094359,0.0007643,
    //     0.00092946,0.00075286,
    //     0.0009156,0.00074164,
    //     0.00090201,0.00073063,
    //     0.00088868,0.00071983,
    //     0.00087561,0.00070924,
    //     0.00086278,0.00069885,
    //     0.0008502,0.00068866,
    //     0.00083785,0.00067866,
    //     0.00082574,0.00066885,
    //     0.00081385,0.00065922,
    //     0.00080219,0.00064977,
    //     0.00079074,0.0006405,
    //     0.0007795,0.00063139,
    //     0.00076846,0.00062245,
    //     0.00075763,0.00061368,
    //     0.000747,0.00060507,
    //     0.00073655,0.00059661,
    //     0.0007263,0.0005883,
    //     0.00071623,0.00058015,
    //     0.00070634,0.00057214,
    //     0.00069663,0.00056427,
    //     0.00068708,0.00055654,
    //     0.00067771,0.00054895,
    //     0.0006685,0.00054149,
    //     0.00065946,0.00053416,
    //     0.00065057,0.00052696,
    //     0.00064183,0.00051988,
    //     0.00063325,0.00051293,
    //     0.00062481,0.0005061,
    //     0.00061652,0.00049938,
    //     0.00060837,0.00049278,
    //     0.00060036,0.00048629,
    //     0.00059248,0.00047991,
    //     0.00058474,0.00047364,
    //     0.00057712,0.00046747,
    //     0.00056964,0.00046141,
    //     0.00056228,0.00045544,
    //     0.00055504,0.00044958,
    //     0.00054792,0.00044381,
    //     0.00054092,0.00043814,
    //     0.00053403,0.00043256,
    //     0.00052725,0.00042708,
    //     0.00052059,0.00042168,
    //     0.00051403,0.00041637,
    //     0.00050758,0.00041114,
    //     0.00050124,0.000406,
    //     0.00049499,0.00040094,
    //     0.00048885,0.00039596,
    //     0.0004828,0.00039107,
    //     0.00047685,0.00038625,
    //     0.00047099,0.0003815,
    //     0.00046522,0.00037683,
    //     0.00045955,0.00037223,
    //     0.00045396,0.00036771,
    //     0.00044846,0.00036325,
    //     0.00044305,0.00035887,
    //     0.00043772,0.00035455,
    //     0.00043247,0.0003503,
    //     0.0004273,0.00034611,
    //     0.00042221,0.00034199,
    //     0.0004172,0.00033793},("Approach phase force to i relation")};
    // int arr_idx;
    // float dist;
    // float mpc_current_req;
    // float i_interpolated;

    RODOS::Matrix_F<4,2> positions{(float []){IDX0_X,IDX0_Y,IDX1_X,IDX1_Y,IDX2_X,IDX2_Y,IDX3_X,IDX3_Y},{"positions from the centres"}};
    bool mag_on_flag = true;

public:

    current_ctrl(const char* thread_name, const int priority , const int stack_size) : Thread(thread_name , priority , stack_size){}

    double compute_required_current_approach();
    //void compute_required_current_allign();
    double sign(const double in);
    void mag_pid_ctrl(magnet_idx idx);
    void actuate_magnets();
    void publish_current_data();
    void init();
    void run();

};

#endif     //current_ctrl.h